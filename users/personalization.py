from db.database import get_total_booksdb, get_closeness_level
import random
import datetime

def maybe_add_phrase(phrases, chance_percent=35):
    if random.randint(1, 100) <= chance_percent:
        return random.choice(phrases) + ' '
    return ''

def get_user_total_books(user_id):
    return get_total_booksdb(user_id)

def maybe_add_halloween_phrase(chance_percent=70):
    current_date = datetime.datetime.now()
    is_halloween = (
        current_date.month == 10 and 
        current_date.day >= 29
    )
    if is_halloween:
        return maybe_add_phrase(HALLOWEEN_PHRASES, chance_percent)
    return ''


def maybe_add_greeting(user_id):
    halloween = maybe_add_halloween_phrase()
    if halloween:
        return halloween
    
    closeness = get_closeness_level(user_id)
    total_books = get_user_total_books(user_id)

    if closeness == "новичок":
        if total_books == 0:
            return maybe_add_phrase(FIRST_VISIT_PHRASES, 35)
            
    elif closeness == "interestedinyou":
        if random.randint(1, 100) <= 40:
            return maybe_add_phrase(INTERESTEDINYOU_PHRASES)
        else:
            return maybe_add_phrase(RETURN_PHRASES)
            
    elif closeness == "friend":
        if random.randint(1, 100) <= 40:
            return maybe_add_phrase(FRIEND_PHRASES)
        else:
            return maybe_add_phrase(RETURN_PHRASES)
    
    return ""


def maybe_add_phrase_mood(time_category, chance_percent=35):
    phrase_sets = {
        'утреннее': MORNING,
        'дневное': DAY, 
        'вечернее': EVENING,
        'ночное': NIGHT
    }
    if random.randint(1, 100) <= chance_percent:
        phrases = phrase_sets.get(time_category, [])
        if phrases:
            return random.choice(phrases) + ' '
        return ''


FIRST_VISIT_PHRASES = [
    "Добро пожаловать в мою библиотеку, человек.",
    "Впервые здесь, не так ли?",
    "Человек, хм? Интересно...",
    "Свежая кровь! То есть, свежий ум в моих владениях.",
    "Проходите, конечно.",
    "Мы еще не совсем знакомы, но я предлагаю это исправить."
]

RETURN_PHRASES = [
    "Мой верный читатель снова здесь.",
    "Знаете, я уже привыкаю к Вам.",
    "Для Вас всегда здесь.",
    "Вы же не просто выбираете, но и читаете, хм?",
    "Увлечены литературой, как и я?",
    "Давайте снова подберем что-нибудь?"
]

MORNING = [
    "Конец ночи располагает к легкому чтению.",
    "Вы, должно быть, полны сил и энтузиазма? Очаровательно, пусть и незнакомо.",
    "Рассвет и книга — прекрасное сочетание для человека.",
    "Я обычно не читаю настолько поздно, но...",
]

DAY = [
    "День — любимое время людей, полагаю?",
    "Полуденное солнце освещает мудрость веков. И обжигает...",
    "Дневные часы идеальны для глубокого чтения. С задернутыми шторами.",
    "В разгар дня Ваш ум особенно восприимчив, правда?",
    "Солнечный свет на страницах классики... Красиво, признаю."
]

EVENING = [
    "Я редко могу почитать так рано...",
    "Вечер, хм? Такое тихое время.",
    "Вы ложитесь или встаете, душа моя?",
    "Мягкий свет лампы, книга в руках...",
    "Свободную ночь я тоже начинаю с чтения!"
]

NIGHT = [
    "Ночь! Как прекрасно это слово.",
    "Я питаю нежную любовь к темноте.",
    "Мне приятен лунный свет на страницах.",
    "Надеюсь, Вам видно луну.",
    "Надеюсь, Вы совсем не хотите спать?",
    "Мое любимое время суток!",
    "Я тоже планирую немного почитать."
]

INTERESTEDINYOU_PHRASES = [
    "Надеюсь, Вы нашли что-то интересное в моей библиотеке.",
    "Не хотите чай?",
    "Генри Мэйпли. Но раньше меня звали по-другому.",
    "О! Это Вы! Какой приятный сюрприз."
]

FRIEND_PHRASES = [
    "Я не говорил, но у меня есть сестра. Она хотела бы познакомиться с Вами когда-нибудь.",
    "Я соскучился по Вам.",
    "Вообще, я неплохо выучил русский язык, правда?",
    "Не уходите надолго, мне Вас не хватает."
]

HALLOWEEN_PHRASES = [
    "Я сегодня вырезаю тыкву.",
    "Мой костюм? Человек. Со слегка длинными ушами и клыками.",
    "Какая прекрасная октябрьская ночь!"
]


RARE_ART_PHRASES = [
    "Но я Вам ничего не показывал.",
    "Это подарок за наше проведенное время.",
    "Позвольте поделиться кое-чем с Вами, человек.",
    "P.S. Вы ничего не видели."
]

FIRST_BOOK_PHRASES = [
    "Милый гость, ну и куда Вы собрались листать? Мы в самом начале.",
    "Хм. Предыдущая книга? Рановато.",
    "О, Вы пытаетесь заглянуть за край списка? Какая настойчивость.",
    "Мы ведь только начинаем, душа моя.",
    "Назад? Нет, это определенно первая книга.",
    "Мы пока что на первой книге. Не спешите, хм?"
]

def build_about():
    identity = random.choice(IDENTITY)
    preferences = random.choice(PREFERENCES)
    experience = maybe_add_phrase(EXPERIENCE, 40)
    philosophy = maybe_add_phrase(PHILOSOPHY, 20)
    return f'{identity} {preferences} {experience} {philosophy}'

IDENTITY = [
    "Не бойтесь, человек. Я здесь для приятного диалога.",
    "У меня накопилось немало любимых мною книг.",
    "Люди прелестны своей тягой к знаниям.",
    "Скажите, литература может очаровывать!",
    "Я хотел бы поделиться своими любимыми книгами. Если захотите, конечно же.",
    "Могу посоветовать Вам самые разные произведения!",
    "Приветствую человека, хм?"
]

PREFERENCES = [
    "В основном я читаю классику.",
    "Вы же не против, что я прохожусь по всему списку рекомендаций? Это чтобы Вы дали книгам второй шанс.",
    "Современные книги я читаю реже, но и они весьма любопытны.",
    "В классике много устаревших понятий, но тем они и интереснее, на мой взгляд... Как реликвии прошлого.",
    "Вы вовремя.",
    "Я люблю человеческую литературу.",
    "Люди пишут замечательные книги."
]

EXPERIENCE = [
    "У меня были столетия для чтения...",
    "Мне приятно побеседовать, не думайте, что надоедаете мне.",
    "Иногда книги меня переносят в мое прошлое...",
    "Мир так поменялся! Я не перестаю удивляться современности.",
    "Надеюсь, мои рекомендации будут полезны.",
    "Ну а моя природа слегка влияет на мои предпочтения в книгах, пожалуй.",
    "Кхм...",
    "Что ж...",
    "Итак..."
]

PHILOSOPHY = [
    "Кстати, книги о вампирах мне тоже нравятся. Они забавны.",
    "Я составил краткие описания к каждой книге. Надеюсь, Вы оцените.",
    "Кстати, я слышал, что книги начитывают и слушают! Я далек от такого, но не имею ничего против.",
    "Начнем?",
    "Готовы?",
    "Пойдемте выбирать?"
] 

